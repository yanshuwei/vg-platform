!function(F,o,U){"use strict";var W="ht",M=F[W],h=M.Default,w=h.def,q=h.getInternal();M.HistoryManager=function(W){this._histories=[],this.setDataModel(W)},w(M.HistoryManager,o,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var e=this;e._betweenTransaction++,1===e._betweenTransaction&&(e._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var E=this,h=E._histories;E._betweenTransaction>0&&E._betweenTransaction--,0===E._betweenTransaction&&(E._transactionHistories&&E._transactionHistories.length&&(h=h.slice(0,E._historyIndex+1),h.push(E._transactionHistories),h.length>E._maxHistoryCount&&(h=h.slice(h.length-E._maxHistoryCount)),E.setHistories(h),E.setHistoryIndex(h.length-1,!0)),delete E._transactionHistories)}},setDataModel:function(f){var $=this,g=$._dataModel;g!==f&&(g&&(delete g._historyManager,g.ump($.handleDataModelPropertyChange,$),g.umm($.$5p,$),g.umd($.$6p,$),g.removeHierarchyChangeListener($.handleHierarchyChange,$),g.removeIndexChangeListener($.handleIndexChange,$)),$._dataModel=f,f&&(f._historyManager=$,f.mp($.handleDataModelPropertyChange,$),f.mm($.$5p,$),f.md($.$6p,$),f.addHierarchyChangeListener($.handleHierarchyChange,$),f.addIndexChangeListener($.handleIndexChange,$)),$.fp("dataModel",g,f),$.clear())},setHistoryIndex:function(q,Q){var w=this,d=w._historyIndex,T=w._histories.length;if(-1>q?q=-1:q>=T&&(q=T-1),d!==q){if(!Q){var B=q-d;B>0?w.$2p(B):0>B&&w.$1p(-B)}w._historyIndex=q,w.fp("historyIndex",d,q),w.dataModel&&w.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(P){var Z=this,b=Z._histories,t=Z._maxHistoryCount;(!P||0>=P)&&(P=10),t!==P&&(Z._maxHistoryCount=P,Z.fp("maxHistoryCount",t,P),b.length>P&&Z.clear())},cloneValue:function(I){return M.Default.clone(I)},isPropertyUndoable:function(A){return A&&!this.ignoredPropertyMap[A]},isDataModelPropertyUndoable:function(O){return O&&!this.ignoreDataModelPropertyMap[O]},$5p:function(R){this.handleChange(R,R.kind)},$6p:function(F){this.handleChange(F,"property")},handleHierarchyChange:function(y){this.handleChange(y,"hierarchy")},handleIndexChange:function(g){this.handleChange(g,"index")},handleDataModelPropertyChange:function(Y){this.handleChange(Y,"dataModelProperty")},toChildrenInfo:function(R){var v={};return v.data=R,v.children=[],R.eachChild(function(y){v.children.push(this.toChildrenInfo(y))},this),v},restoreChildren:function(b){var $=b.data;b.children.forEach(function(A){var r=A.data;r.getParent()!==$&&$.addChild(r),this._dataModel.contains(r)||this._dataModel.add(r),this.restoreChildren(A)},this)},handleChange:function(I,u){var z=this;if(!(z._disabled||z._isUndoRedoing||h.loadingRefGraph)){var V,N=(z._histories,I.data),b=I.property;if(!N||!(N._refGraph||N instanceof M.RefGraph)){if("property"===u)z.isPropertyUndoable(b,N)&&(V={kind:u,data:N,property:b,oldValue:z.cloneValue(I.oldValue,N,b),newValue:z.cloneValue(I.newValue,N,b),event:I});else if("hierarchy"===u||"index"===u)V={kind:u,data:N,oldIndex:I.oldIndex,newIndex:I.newIndex,event:I};else if("clear"===u)V={kind:u,json:I.json,event:I};else if("add"===u){if(V={kind:u,data:N,event:I,childrenInfo:this.toChildrenInfo(N),parent:N.getParent()},V.parent){var R=z._dataModel.getSiblings(N);V.siblingsIndex=R.indexOf(N)}N instanceof M.Node&&(V.host=N.getHost(),V.attaches=N.getAttaches()?N.getAttaches().toArray():U),N instanceof M.Edge&&(V.source=N.getSource(),V.target=N.getTarget())}else"remove"===u?V={kind:u,data:N,event:I}:"dataModelProperty"===u&&z.isDataModelPropertyUndoable(b,N)&&(V={kind:u,property:b,oldValue:z.cloneValue(I.oldValue,N,b),newValue:z.cloneValue(I.newValue,N,b),event:I});z.addHistory(V)}}},addHistory:function(G){var c=this;if(G)if(c._betweenTransaction){var C=!1;if("property"===G.kind||"dataModelProperty"===G.kind)for(var H=c._transactionHistories.length-1;H>=0;H--){var D=c._transactionHistories[H];if(G.kind===D.kind&&G.property===D.property&&G.data===D.data){G.oldValue=D.oldValue,c._transactionHistories[H]=G,C=!0;break}}C||c._transactionHistories.push(G)}else{var I=c._histories;I=I.slice(0,c._historyIndex+1),I.push([G]),I.length>c._maxHistoryCount&&(I=I.slice(I.length-c._maxHistoryCount)),c.setHistories(I),c.setHistoryIndex(I.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(D){(!D||0>=D)&&(D=1),this.setHistoryIndex(this._historyIndex-D)},$1p:function(t){if(this.canUndo()){var B,F=this,i=F._dataModel,b=F._histories,f=F._historyIndex,L=0;for(F._isUndoRedoing=!0,h.setIsolating(!0);t>0;){if(f>=0&&f<b.length){L++,B=b[f],f--;for(var o=B.length-1;o>=0;o--){var J=B[o],G=J.kind,$=J.data,s=J.property,a=J.event,x=this.cloneValue(J.oldValue,$,s);if(J.undo)J.undo();else if("add"===G)i.remove($,{keepChildren:!0});else if("remove"===G)i.contains($)||i.add($,a.rootsIndex,a.datasIndex);else if("clear"===G)i.deserialize(h.clone(J.json));else if("property"===G)if("parent"===s)x?x.addChild($,a.oldIndex):($.setParent(x),a.oldIndex>=0&&i.moveTo($,a.oldIndex));else{var V=null;0===s.indexOf("a:")?(V="attr",s=s.replace("a:","")):0===s.indexOf("s:")?(V="style",s=s.replace("s:","")):0===s.indexOf("f:")&&(V="field",s=s.replace("f:","")),q.setPropertyValue($,V,s,x)}else if("dataModelProperty"===G){var V=null;0===s.indexOf("a:")?(V="attr",s=s.replace("a:","")):0===s.indexOf("s:")?(V="style",s=s.replace("s:","")):0===s.indexOf("f:")&&(V="field",s=s.replace("f:","")),q.setPropertyValue(i,V,s,x)}else"hierarchy"===G?i.moveTo($,J.oldIndex):"index"===G&&i.moveToIndex($,J.oldIndex)}}t--}h.setIsolating(!1),delete F._isUndoRedoing,F.afterUndo(L)}},afterUndo:function(){},redo:function(e){(!e||0>=e)&&(e=1),this.setHistoryIndex(this._historyIndex+e)},$2p:function(O){if(this.canRedo()){var o,j=this,F=j._dataModel,b=j._histories,f=j._historyIndex,v=0;for(j._isUndoRedoing=!0,h.setIsolating(!0);O>0;){if(f>=-1&&f<b.length-1){v++,f++,o=b[f];for(var n=0;n<o.length;n++){var J=o[n],z=J.kind,w=J.data,I=J.property,a=J.event,Q=this.cloneValue(J.newValue,w,I);if(J.redo)J.redo();else if("add"===z)J.parent&&!w.getParent()&&J.parent.addChild(w,J.siblingsIndex),F.contains(w)||F.add(w,a.rootsIndex,a.datasIndex),this.restoreChildren(J.childrenInfo),w instanceof M.Node&&(w.setHost(J.host),J.attaches&&J.attaches.forEach(function(r){r.setHost(w)})),w instanceof M.Edge&&(w.setSource(J.source),w.setTarget(J.target));else if("remove"===z)F.remove(w);else if("clear"===z)F.clear();else if("property"===z)if("parent"===I)Q?Q.addChild(w,a.newIndex):(w.setParent(Q),a.newIndex>=0&&F.moveTo(w,a.newIndex));else{var l=null;0===I.indexOf("a:")?(l="attr",I=I.replace("a:","")):0===I.indexOf("s:")?(l="style",I=I.replace("s:","")):0===I.indexOf("f:")&&(l="field",I=I.replace("f:","")),q.setPropertyValue(w,l,I,Q)}else if("dataModelProperty"===z){var l=null;0===I.indexOf("a:")?(l="attr",I=I.replace("a:","")):0===I.indexOf("s:")?(l="style",I=I.replace("s:","")):0===I.indexOf("f:")&&(l="field",I=I.replace("f:","")),q.setPropertyValue(F,l,I,Q)}else"hierarchy"===z?F.moveTo(w,J.newIndex):"index"===z&&F.moveToIndex(w,J.newIndex)}}O--}h.setIsolating(!1),delete j._isUndoRedoing,this.afterRedo(v)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);